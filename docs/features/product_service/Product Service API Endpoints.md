
**Purpose:** This page details the HTTP API endpoints exposed by the `product-service`.
**Audience:** Developers, Testers, API Consumers, Students
**Prerequisites:** [Product Service Features Overview](./Product Service Features Overview.md)
**Related Pages:** [product-service/src/main.go](), [product-service/src/handler.go](), [product-service/src/repository.go](), [Feature: Update Product Stock](./Feature: Update Product Stock.md)

---

## 1. Overview

The service exposes a REST-like API for managing products.

*   **Framework:** Fiber (`v2`)
*   **Base Path:** `/` (relative to the service port, default `8082`)
*   **Authentication:** None currently implemented.
*   **Instrumentation:** Requests are automatically traced via `otelfiber` middleware.

---

## 2. Endpoint Definitions

| Method | Path                           | Handler Function           | Description                                    |
| :----- | :----------------------------- | :------------------------- | :--------------------------------------------- |
| `GET`  | `/health`                      | (inline in `main.go`)      | Minimal health check, returns `{"status":"ok (minimal)"}`. |
| `GET`  | `/products`                    | `handler.GetAllProducts`   | Retrieves a list of all products.              |
| `GET`  | `/products/:productID`         | `handler.GetProductByID`   | Retrieves a single product by its ID.          |
| `GET`  | `/status`                      | `handler.HealthCheck`      | Returns `{"status": "ok"}`.                  |
| `PATCH`| `/products/:productID/stock`   | `handler.UpdateProductStock` | Updates the stock level for a specific product.|
| `POST` | `/products`                    | `handler.CreateProduct`    | Creates a new product.                         |

---

## 3. Request/Response Details

*   **`GET /products`:**
    *   **Success Response (200 OK):** `Content-Type: application/json`
        ```json
        [
          { "id": "...", "name": "...", ... }, // Updated to use 'id'
          ...
        ]
        ```
        (Array of [Product](#product) objects)
    *   **Error Response:** Standard Fiber error (e.g., 500 if repository read fails).

*   **`GET /products/:productID`:**
    *   **Path Parameter:** `productID` (string) - The ID of the product to retrieve.
    *   **Success Response (200 OK):** `Content-Type: application/json`
        ```json
        {
          "id": "...", "name": "...", ... }
        ```
        (Single [Product](#product) object)
    *   **Error Response:** Standard Fiber error (e.g., 500 if repository read fails, or likely 404/500 if product not found by service/repository).

*   **`GET /status`:**
    *   **Success Response (200 OK):** `Content-Type: application/json`
        ```json
        { "status": "ok" }
        ```

*   **`PATCH /products/:productID/stock`:**
    *   **Path Parameter:** `productID` (string) - The ID of the product to update.
    *   **Request Body:** `Content-Type: application/json`
        ```json
        { "stock": <integer> }
        ```
        (Uses `updateStockPayload` struct internally)
    *   **Validation:** Checks for non-negative `stock` value, primarily handled in the service layer ([Feature: Update Product Stock](./Feature: Update Product Stock.md)). **// Fix Applied**
    *   **Success Response (200 OK):** `Content-Type: application/json`
        ```json
        { "status": "ok" }
        ```
    *   **Error Response:** Standard Fiber error (e.g., 400 Bad Request if body parsing fails or stock is invalid, 404/500 if product not found, 500 if repository fails).
    *   **Telemetry Note:** The underlying repository operation adds the `product.old_stock` attribute to its trace span. See [Feature: Update Product Stock](./Feature: Update Product Stock.md). **// Fix Applied**

*   **`POST /products`:**
    *   **Request Body:** `Content-Type: application/json`
        ```json
        {
          "name": "string",
          "description": "string",
          "price": number,
          "stock": integer
        }
        ```
        (Uses `createProductPayload` struct internally. `id` is generated by the service.) // Updated 'productID' to 'id'
    *   **Validation:** Checks for required `name` and non-negative `price`/`stock`. This validation primarily occurs in the service layer (`service.go`). **// Fix Applied**
    *   **Success Response (201 Created):** `Content-Type: application/json`
        ```json
        { "id": "...", "name": "...", ... } // Updated to use 'id'
        ```
        (The newly created [Product](#product) object with its generated ID)
    *   **Error Response:** Standard Fiber error (e.g., 400 Bad Request if body parsing or validation fails, 409 Conflict if ID generation collides (unlikely) or if repository indicates conflict, 500 if repository fails).

---

## Appendix: Data Structures

### Product
```go
// Defined in product-service/src/repository.go
type Product struct {
    ID          string  `json:"id"` // Updated ProductID -> ID and json tag
    Name        string  `json:"name"`
    Description string  `json:"description"`
    Price       float64 `json:"price"`
    Stock       int     `json:"stock"`
    // Removed Category and Tags as they are not in repository.go's struct
}
```

### Payloads
```go
// Defined in product-service/src/handler.go
// Note: These payloads are used for request binding in the handler.
// They don't include 'id' because it's either generated (POST) or comes from the URL path (PATCH).
type createProductPayload struct {
    Name        string  `json:"name"`
    Description string  `json:"description"`
    Price       float64 `json:"price"`
    Stock       int     `json:"stock"`
}

type updateStockPayload struct {
    Stock int `json:"stock"`
}
```

---

## 4. Teaching Points & Demo Walkthrough

*   **Key Takeaway:** The API provides standard CRUD-like operations for products. Fiber framework is used for routing and handling.
*   **Demo Steps:**
    1.  Show the route definitions in `main.go`.
    2.  Use `curl` or a tool like Postman/Insomnia to make requests to each endpoint, showing expected request bodies and resulting responses.
    3.  Demonstrate error cases (e.g., bad request body, requesting non-existent product ID).
    4.  Show the trace generated in SigNoz for one of the API calls, highlighting the HTTP attributes added by `otelfiber` and any nested spans from handler/service/repo.

---

**Last Updated:** 2024-07-30
